name: Build Android APK

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v5

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Restore keystore from secret
        run: |
          mkdir -p ~/.keystore
          printf '%s' "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > ~/.keystore/release.keystore
          
      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Sign APK with apksigner
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          version=$(./gradlew -q :app:printVersion)
          BUILD_APK=app/build/outputs/apk/release/app-release-unsigned.apk
          SIGNED_APK=dist/app-release-${version}.apk
          mkdir -p dist
          apksigner sign \
            --ks ~/.keystore/release.keystore \
            --ks-pass pass:$KEYSTORE_PASSWORD \
            --key-pass pass:$KEY_PASSWORD \
            --ks-key-alias $KEY_ALIAS \
            --out $SIGNED_APK \
            $BUILD_APK
          apksigner verify --print-certs $SIGNED_APK

      - name: Upload APK to Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/app-release-*.apk
